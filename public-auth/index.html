<script>
  const API_URL = 'https://ocr-translate-api.vercel.app/api/translate';

  async function translateImage(base64) {
    loaderContainer.classList.remove('hidden');
    translationOutput.classList.add('hidden');
    errorOutput.classList.add('hidden');
    statusText.textContent = 'AIが画像を解析・翻訳中です...';

    try {
      // ★ ここで最新トークンを取得
      const token = await window.getFreshIdToken();
      if (!token) throw new Error('AUTH_REQUIRED');

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          // ★ Authorization を必ず付ける
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ base64ImageData: base64 })
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          const msg = res.status === 401
            ? '認証エラー：再ログインしてください。'
            : 'このアカウントではご利用いただけません（未許可/期限切れの可能性）。';
          throw new Error(msg);
        }
        throw new Error('APIエラー');
      }

      const data = await res.json();
      loaderContainer.classList.add('hidden');
      translationOutput.classList.remove('hidden');
      translationOutput.querySelector('p').textContent = data.translated || '(翻訳テキストがありません)';
    } catch (err) {
      loaderContainer.classList.add('hidden');
      errorOutput.classList.remove('hidden');
      errorMessage.textContent =
        err?.message === 'AUTH_REQUIRED'
          ? 'ログイン状態を確認できません。いったんログアウトしてログインし直してください。'
          : (err?.message || '翻訳に失敗しました');
    }
  }
</script>
